<!--
 * Copyright (c) 2013 - 2014, b3devs@gmail.com
 *
 * Licensed under the Common Development and Distribution License (the "License"); you may not use this
 * source code or associated Google document except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://opensource.org/licenses/cddl1.php
 *
 * Any modifications to this Software that You distribute or otherwise make available in Executable
 * form must also be made available in Source Code form and that Source Code form must be distributed
 * only under the terms of this License.
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
-->


<style>
.window_area
{
  font-family: Calibri;
  font-size: Medium;
  width: 100%;
  height: 100%;
  overflow: auto;
}
</style>

<script>
alert('loading mint_login.html');
//try
//{
//  window.addEventListener("load", function() { init(); });
//}
//catch (e)
//{
//  alert(e.toString());
//}
</script>

<?
var mintAccount = Settings.getSetting(Const.IDX_SETTING_MINT_LOGIN);
?>

<form class="window_area">

<table>
<tr>
<td>Email:</td><td><input id="email" type="text" value="test---" style="width: 200px;" /></td>
<!--
<td>Email:</td><td><input id="email" type="text" value="<?!= mintAccount ?>" style="width: 200px;" /></td>
-->
</tr>

<tr>
<td>Password:</td><td><input id="password" type="password" style="width: 200px;"/></td>
</tr>
</table>

<div id="login_fail" style="visibility: hidden; text-align: center; color: red;">Login failed</div>

<div>
<p style="text-align: center; margin-bottom: 0;">
<input id="ok_button" type="submit" value="OK" onclick="onOK();" style="height: 30px; width: 75px;"/>
&nbsp;&nbsp;
<input id="cancel_button" type="button" value="Cancel" onclick="onCancel();" style="height: 30px; width: 75px;"/>
</p>
</div>

</form>

<script type="text/javascript">
/*
// Send a "window ping" immediately so the LoginWindow script knows the window is open
google.script.run.invokeFunction("MojitoLib.Ui.LoginWindow.onWindowPing");

// Also send a "window ping" event every few seconds to the MintLogin script to let it know the login window is still open.
setInterval(function() { google.script.run.invokeFunction("MojitoLib.Ui.LoginWindow.onWindowPing");}, 3000);


function onOK() {
  try
  {
    var args = {
      email : document.getElementById("email").value,
      password : document.getElementById("password").value,
    };

    document.getElementById("ok_button").disabled = true;
    document.getElementById("login_fail").style.visibility = "hidden";

    google.script.run.withSuccessHandler(onLoginResult).invokeFunction("MojitoLib.Ui.LoginWindow.onDoLogin", args);
  }
  catch (e)
  {
    // Not much we can do. Just eat it.
  }
}

function onCancel() {
  google.script.run.withSuccessHandler(closeWindow).invokeFunction("MojitoLib.Ui.LoginWindow.onCancel");
}

function onLoginResult(loginSuccess) {
  if (loginSuccess) {
    closeWindow();
    return;
  }

  // Login failed. Show the "Login failed" text and set focus to the password field.
  document.getElementById("login_fail").style.visibility = "visible";
  document.getElementById("ok_button").disabled = false;
  var passwordField = document.getElementById("password");
  passwordField.value = "";
  passwordField.focus(); // focus() doesn't work due to security restrictions in Google's "caja" sandbox...
}

function closeWindow() {
  google.script.host.close();
}

// FIXME: Need to set focus to the email or password field when the window is done loading.
// Two problems: 1. Normally we would implement an "onload" handler, but that doesn't seem to work
// here. 2. Google's "caja" sandbox that hosts this html apparently blocks the focus() function
// for security reasons (?). So, the user will just have to click in the desired field before typing.

function init() {

  try
  {
  // Set focus to a email or password field
  var emailField = document.getElementById("email");
  if (emailField.value == "") {
    emailField.focus();
  } else {
    document.getElementById("password").focus();
  }
  }
  catch (e)
  {
    alert(e.toString());
  }
}

//setTimeout(function() { init(); }, 1000);
*/
</script>
